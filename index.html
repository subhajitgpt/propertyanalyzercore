<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Property Finder & POI Analysis</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --ink:#0f172a; --muted:#677084; --soft:#e7eef5; --brand:#2563eb; --brand2:#7c3aed; --card:#ffffff; }
    body{background:#f7f9fc;color:var(--ink)}
    .navbar{background:linear-gradient(90deg,#0ea5e9,#6366f1)}
    .navbar .navbar-brand,.navbar .navbar-text{color:#fff}
    .card-soft{border:1px solid #e7eef5;box-shadow:0 4px 14px rgba(16,24,40,.06);background:var(--card);border-radius:18px}
    .mapbox{width:100%;height:440px;border:1px solid #e7eef5;border-radius:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .prewrap{white-space:pre-wrap}
    .badge-soft{background:#eef2ff;color:#3730a3;border-radius:999px}
    .nav-tabs{border-bottom:1px solid #e7eef5}
    .stat{border:1px solid #e7eef5;border-radius:16px;padding:14px 16px;background:#fff}
    .stat .label{color:#677084;font-size:.9rem}
    .stat .value{font-weight:700;font-size:1.15rem}
    .btn-pill{border-radius:999px}
    .form-help{font-size:.85rem;color:#677084}
    .finder-cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
    @media (max-width: 992px){ .finder-cards{grid-template-columns:1fr} }
    .prop-card{border:1px solid #e7eef5;border-radius:16px;background:#fff;padding:14px;transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;}
    .prop-card:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(20,30,60,.08)}
    .prop-title{font-weight:800}
    .pill{border-radius:999px;padding:.2rem .55rem;background:#f1f5ff;border:1px solid #e7eef5;font-size:.8rem}
    .rating{display:inline-flex;align-items:center;gap:6px}
    .rating .star{color:#f59e0b}
    .next-steps-notice{
      background:linear-gradient(135deg,#dc2626,#b91c1c);
      color:white;
      padding:16px;
      margin-top:20px;
      border-radius:12px;
      text-align:center;
      font-weight:bold;
      box-shadow:0 4px 12px rgba(220,38,38,0.3);
      border:2px solid #991b1b;
    }
    .next-steps-notice:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(220,38,38,0.4);
    }

  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg mb-3">
    <div class="container-fluid">
      <span class="navbar-text">Property Finder ‚Ä¢ POI Analysis</span>
      <div class="ms-auto d-flex gap-2 align-items-center">
      </div>
    </div>
  </nav>

  <div class="container">
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-finder" data-bs-toggle="tab" data-bs-target="#panel-finder" type="button" role="tab">1) Property Finder (AI)</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-retail" data-bs-toggle="tab" data-bs-target="#panel-retail" type="button" role="tab">2) Points of Interest Analysis</button>
      </li>
    </ul>

    <div class="tab-content py-3">
      <!-- ===== Property Finder (AI) ===== -->
      <div class="tab-pane fade show active" id="panel-finder" role="tabpanel">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card card-soft p-3">
              <h6 class="mb-2">Find Housing Projects (Exact Map Names)</h6>
              <div class="form-help mb-2">
                Set preferences and we‚Äôll return <b>project/society names</b> matching Google Maps so you can paste them into the search in Tab 2.
              </div>
              <div class="row g-2">
                <div class="col-12">
                  <label class="form-label">Country</label>
                  <select id="pfCountry" class="form-select">
                    <option value="India" selected>India</option>
                    <option value="UAE">UAE</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">City</label>
                  <input id="pfCity" class="form-control" placeholder="e.g., Kolkata, Dubai">
                </div>
                <div class="col-6">
                  <label class="form-label">Currency</label>
                  <select id="pfCurrency" class="form-select">
                    <option value="INR" selected>‚Çπ INR</option>
                    <option value="AED">ÿØ.ÿ• AED</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">Apt Type</label>
                  <select id="pfType" class="form-select">
                    <option value="1 BHK">1 BHK</option>
                    <option value="2 BHK" selected>2 BHK</option>
                    <option value="3 BHK">3 BHK</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">Budget</label>
                  <input id="pfBudget" type="number" class="form-control" placeholder="e.g., 6500000">
                  <div class="form-help">Numeric (in selected currency)</div>
                </div>
                <div class="col-6">
                  <label class="form-label">Locality</label>
                  <input id="pfLocality" class="form-control" placeholder="e.g., New Town, Marina, Downtown">
                </div>
              </div>
              <div class="mt-3 d-grid gap-2">
                <button id="btnFindProperties" class="btn btn-primary btn-pill" type="button">Find Projects</button>
                <button id="btnClearPF" class="btn btn-outline-secondary btn-pill" type="button">Reset</button>
              </div>
              <div id="pfError" class="text-danger small mt-2 d-none"></div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card card-soft p-3">
              <div class="d-flex align-items-center justify-content-between">
                <h6 class="mb-0">AI Suggestions (Projects/Societies)</h6>
                <div class="d-flex gap-2">
                  <button id="btnPFCopyNames" class="btn btn-outline-primary btn-sm" disabled>Copy Names</button>
                  <button id="btnPFExportCSV" class="btn btn-outline-secondary btn-sm" disabled>Export CSV</button>
                  <button id="btnPFExportXLSX" class="btn btn-outline-secondary btn-sm" disabled>Export XLSX</button>
                </div>
              </div>
              <div class="form-help">Each project name is normalized to match its <b>Google Maps place name</b> when possible.</div>
              <div id="pfSummary" class="mt-3 mono prewrap text-muted">‚Äî</div>

              <div id="pfCards" class="finder-cards mt-2"></div>

              <div class="table-responsive mt-3">
                <table class="table table-sm table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>#</th><th>Project (Exact Map Name)</th><th>Area</th><th>Type</th><th>Size</th><th>Price</th><th>Band</th><th>Rating</th>
                    </tr>
                  </thead>
                  <tbody id="pfTableBody"><tr><td colspan="8" class="text-muted">Run a search to populate results.</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Next Steps Notice -->
        <div class="next-steps-notice">
          <strong>üìç Next Steps: Navigate to Tab 2 to analyze points of interest around selected projects.</strong>
        </div>
      </div>

      <!-- ===== Retail (Tab 2) ===== -->
      <div class="tab-pane fade" id="panel-retail" role="tabpanel">
        <div class="row g-3">
          <div class="col-lg-7">
            <div class="card card-soft p-3">
              <div class="d-flex align-items-center justify-content-between">
                <span class="badge badge-soft px-3 py-2">Search location</span>
                <div class="d-flex gap-2">
                </div>
              </div>
              <div class="position-relative my-2">
                <span class="position-absolute" style="left:10px;top:50%;transform:translateY(-50%);opacity:.6">üîé</span>
                <input id="searchBox2" class="form-control ps-5" placeholder="Paste a project/society name here‚Ä¶">
              </div>
              <div id="map2" class="mapbox"></div>

              <div class="row g-2 mt-2">
                <div class="col-6">
                  <label class="form-label">Search Radius: <b><span id="retailRadiusLbl">1000</span> m</b></label>
                  <input id="retailRadius" type="range" class="form-range" min="200" max="5000" value="1000" step="50">
                </div>
                <div class="col-6">
                  <label class="form-label">Max Places per Type: <b><span id="retailLimitLbl">40</span></b></label>
                  <input id="retailLimit" type="range" class="form-range" min="10" max="60" value="40" step="5">
                </div>
              </div>

              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Min Rating</label>
                  <select id="minRating" class="form-select">
                    <option value="0" selected>Any</option><option value="3.5">3.5+</option><option value="4.0">4.0+</option><option value="4.5">4.5+</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Open Now</label>
                  <select id="openNow" class="form-select">
                    <option value="any" selected>Any</option><option value="yes">Yes</option>
                  </select>
                </div>
              </div>

              <div class="text-muted small mt-2">Selected: <span id="retailLatLng">‚Äî</span></div>
            </div>
          </div>

          <div class="col-lg-5">
            <div class="card card-soft p-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-1">POI Types &amp; Weights</h6>
              </div>
              <div class="text-muted small mb-1">Toggle types &amp; adjust weights (importance).</div>

              <div id="poiLegend" class="small mb-2"></div>
              <div id="poiList" class="row g-2 mt-2"></div>

              <div class="mt-3 d-grid gap-2">
                <button id="btnScanPOI" class="btn btn-primary btn-pill">Scan Area (Places)</button>
                <button id="btnScoreRetail" class="btn btn-outline-primary btn-pill" disabled>Compute Score</button>
                <div id="scoreErr" class="text-danger small mt-2 d-none"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-soft p-3 mt-3">
          <div class="d-flex align-items-center justify-content-between">
            <h6 class="mb-0">Feasibility Summary</h6>
            <button id="btnResetRetail" class="btn btn-sm btn-outline-secondary btn-pill">Reset</button>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-2"><div class="stat"><div class="label">Raw Score</div><div id="retRaw" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Normalized</div><div id="retNorm" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Types Scanned</div><div id="retTypes" class="value">‚Äî</div></div></div>
            <div class="col-md-2"><div class="stat"><div class="label">Radius (m)</div><div id="retRadius" class="value">‚Äî</div></div></div>
            <div class="col-md-4"><div class="stat"><div class="label">Centers &amp; Filters</div><div id="retMeta" class="value small">‚Äî</div></div></div>
          </div>

          <div class="table-responsive mt-3">
            <table class="table table-sm">
              <thead class="table-light">
                <tr><th>Type</th><th>Count</th><th>Avg Rating</th><th>Weight</th><th>Component</th></tr>
              </thead>
              <tbody id="retTableBody"></tbody>
            </table>
          </div>

          <pre id="retailBreakdown" class="form-control mono prewrap mt-2" style="min-height:110px;">‚Äî</pre>
        </div>

        <!-- Flat POI List -->
        <div class="card card-soft p-3 mt-3">
          <div class="d-flex flex-wrap gap-2 align-items-end">
            <div>
              <label class="form-label mb-1">Category (POI Type)</label>
              <select id="poiCategory" class="form-select form-select-sm" style="min-width:260px">
                <option value="" selected disabled>‚Äî select after scanning ‚Äî</option>
              </select>
            </div>
            <div>
              <label class="form-label mb-1">Quick Filter (text)</label>
              <input id="poiFilterText" class="form-control form-select-sm" placeholder="name/address contains...">
            </div>
            <div class="ms-auto d-flex gap-2">
              <button id="btnExportCSV" class="btn btn-outline-secondary btn-sm" type="button">Export CSV</button>
              <button id="btnExportXLSX" class="btn btn-outline-secondary btn-sm" type="button">Export XLSX</button>
            </div>
          </div>
          <div class="table-responsive mt-3">
            <table class="table table-sm table-hover" id="poiFlatTable">
              <thead class="table-light">
                <tr>
                  <th>#</th><th>Name</th><th>Address</th><th>Rating</th><th>Ratings Count</th><th>Type</th><th>Google Maps</th>
                </tr>
              </thead>
              <tbody id="poiFlatBody"><tr><td colspan="7" class="text-muted">Scan an area, choose a category, and the list will appear here.</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>


    </div>
  </div>



  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // =======================================================
    // Encrypted keys (no UI)
    const GMAPS_KEY_ENCRYPTED = "Qs5skmSuUzGSs5TwYxnoazaHLEgJ995LrvyyWiziwWdIzkyAfrYq";
    const OPENAI_KEY_ENCRYPTED = "cOw7g0W4eGXznpOpZzSoOFmOIm04p+lSkou0OhHs9D1LxWarB5lzePb5ss9QHLpgM5w9TQu9xmagjqUtGv/+BG3lXsJgk1oA8orawWIylTpUvw81L6jveoKPlCtUy8AmbekhmX3uIhrCkZrZExCBemLlCXNY87VUh5e/NBfo0DtM/nzHYbxQfOD5h8dKL5ZPVr03dgup2HPxj5IBC/f1BjLgIrI=";

    let GMAPS_KEY="", OPENAI_KEY="";
    let pyodide=null, pyReady=false, mapsLoaded=false;

    // ---------- Pyodide init & decrypt ----------
    (async () => {
      try{
        pyodide = await loadPyodide();
        await pyodide.runPythonAsync(`
import base64, hashlib
def decrypt_key(encrypted_data, passphrase="default_salt_2024"):
    try:
        encrypted_bytes = base64.b64decode(encrypted_data)
        key_hash = hashlib.sha256(passphrase.encode()).digest()
        out = bytearray()
        for i, b in enumerate(encrypted_bytes):
            out.append(b ^ key_hash[i % len(key_hash)])
        return out.decode('utf-8')
    except Exception:
        return ""
        `);
        pyReady = true;
        await decryptKeysAndLoad();
      }catch(e){
        console.error("Pyodide init failed", e);
        fallbackNoKeys();
      }
    })();

    async function decryptKeysAndLoad(){
      try{
        if(pyReady && pyodide){
          if (GMAPS_KEY_ENCRYPTED && !GMAPS_KEY){
            pyodide.globals.set('enc_gmaps', GMAPS_KEY_ENCRYPTED);
            GMAPS_KEY = await pyodide.runPythonAsync(`decrypt_key(enc_gmaps)`);
          }
          if (OPENAI_KEY_ENCRYPTED && !OPENAI_KEY){
            pyodide.globals.set('enc_openai', OPENAI_KEY_ENCRYPTED);
            OPENAI_KEY = await pyodide.runPythonAsync(`decrypt_key(enc_openai)`);
          }
        }
      }catch(e){ console.warn("Decryption error", e); }
      loadMapsIfKey();
    }
    function loadMapsIfKey(){
      if(mapsLoaded || !GMAPS_KEY) return;
      const s=document.createElement('script');
      s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GMAPS_KEY)}&libraries=places`;
      s.async=true; s.defer=true;
      s.onload=()=>{ mapsLoaded=true; safeInitMaps(); };
      s.onerror=()=>{ console.error('Failed to load Google Maps.'); };
      document.head.appendChild(s);
    }
    function fallbackNoKeys(){ setTimeout(decryptKeysAndLoad, 1200); }

    // =======================================================
    // Finder helpers
    const pfCardsEl = ()=>document.getElementById('pfCards');
    const pfSummaryEl = ()=>document.getElementById('pfSummary');
    const pfTableBody = ()=>document.getElementById('pfTableBody');
    const pfBtnCSV = ()=>document.getElementById('btnPFExportCSV');
    const pfBtnXLSX = ()=>document.getElementById('btnPFExportXLSX');
    const pfBtnCopyNames = ()=>document.getElementById('btnPFCopyNames');
    let pfResults = [];

    function pfCurrencySymbol(c){ return ({"INR":"‚Çπ","AED":"AED ","USD":"$","SGD":"S$","GBP":"¬£"})[c] || ""; }
    function fmtMoney(n, cur){ if(n==null || isNaN(n)) return "-"; const sym = pfCurrencySymbol(cur); return sym + Math.round(Number(n)).toLocaleString(); }
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

    // Build OpenAI prompt
    function pfPrompt(payload){
      return [
        { role: "system", content:
"You are a meticulous real-estate analyst.\n\
Return STRICT JSON with housing PROJECTS (societies/complexes) only.\n\
Each \"project_name\" must be the EXACT Google Maps place name if possible.\n\n\
Schema:\n\
{\n\
  \"summary\": \"1-3 bullets (city overview, price sanity, key trade-offs)\",\n\
  \"picks\": [\n\
    {\n\
      \"project_name\": \"Exact Google Maps place name\",\n\
      \"area\": \"Area/Locality\",\n\
      \"apartment_type\": \"1 BHK | 2 BHK | 3 BHK\",\n\
      \"size\": \"e.g., 1100 sqft\",\n\
      \"price\": 0,\n\
      \"price_band\": \"e.g., 65L‚Äì78L\",\n\
      \"pros\": [\"bullet\", \"bullet\"],\n\
      \"cons\": [\"bullet\"],\n\
      \"notes\": \"Short reasoning (<=25 words)\"\n\
    }\n\
  ]\n\
}" },
        { role: "user", content:
`Find housing projects (not individual units) for ${payload.type} in ${payload.city}, ${payload.country}.
Currency=${payload.currency}; Budget=${payload.budget}; Preferred locality="${payload.locality || "(none)"}".
Return 8‚Äì14 diverse, realistic projects. Size in sqft. Bands can vary ¬±20% around budget if needed for variety.` }
      ];
    }

    // Heuristic fallback (16 candidates)
    function localHeuristicFinder({country, city, currency, type, budget, locality}){
      const areasByCity = {
        "kolkata":["New Town","Salt Lake","Rajarhat","Tollygunge","Behala","Dum Dum","Ballygunge","Jadavpur","Ultadanga","Kasba","Baguiati","Garia","Narendrapur","EM Bypass","Lake Town","Barasat","Madhyamgram","Howrah","Park Street","Esplanade"],
        "dubai":["Marina","JLT","Business Bay","Downtown","JVC","Barsha","Silicon Oasis","Mirdif","Discovery Gardens","Deira","Bur Dubai","Greens","Tecom","IMPZ","Sports City","Arjan"],
        "singapore":["Tampines","Jurong East","Punggol","Serangoon","Bukit Timah","Toa Payoh","Kallang","Clementi","Queenstown","Woodlands","Sengkang","Yishun","Bukit Panjang","Hougang","Geylang","Novena"]
      };
      const suffixes = ["Heights","Residency","Enclave","Greens","Lakeview","Garden","Vista","Court","Paradise","Orchid","Crest","Grande","Harbour","Meadows","Valley","Arcade"];
      const key = (city||"").toLowerCase().trim();
      const pool = areasByCity[key] || ["Central","East","West","North","South","Midtown","Uptown","Riverside","Park","Harbour","Hill","Valley","Lake","Heights","Crescent","Arcade"];
      const picks = [];
      const base = Number(budget)||5000000;
      for(let i=0;i<Math.min(16,pool.length);i++){
        const bandLow = Math.round(base*(0.72+0.03*i));
        const bandHigh= Math.round(bandLow*1.14);
        const pseudo = pool[i] + " " + suffixes[i % suffixes.length];
        picks.push({
          project_name: pseudo,
          area: pool[i],
          apartment_type: type,
          size: `${900 + 40*i} sqft`,
          price: Math.round((bandLow+bandHigh)/2),
          price_band: `${fmtMoney(bandLow,currency)}‚Äì${fmtMoney(bandHigh,currency)}`,
          pros: ["Good connectivity","Reasonable social infra"],
          cons: ["Check maintenance","Stock varies"],
          notes: ""
        });
      }
      return {
        summary: `‚Ä¢ ${city}: ${type} projects across ${picks.length} areas.\n‚Ä¢ Bands are indicative; verify tower age & maintenance.\n‚Ä¢ Prioritize metro, hospitals, schools.`,
        picks
      };
    }

    // Try to normalize each project_name to EXACT Google Maps place name via Places Text Search
    async function enrichWithPlaceMeta(picks, city){
      if(!window.google || !google.maps || !google.maps.places) return picks;
      const service = new google.maps.places.PlacesService(document.createElement('div'));

      function textSearchExact(q){
        return new Promise(resolve=>{
          service.textSearch({query:q}, (res, status)=>{
            if(status===google.maps.places.PlacesServiceStatus.OK && res && res.length){
              const r=res[0];
              resolve({
                name: r.name||"",
                rating: (typeof r.rating==='number')?r.rating:null,
                lat: r.geometry?.location?.lat?.(),
                lng: r.geometry?.location?.lng?.(),
                vicinity: r.vicinity || r.formatted_address || ""
              });
            } else resolve(null);
          });
        });
      }

      const out=[];
      for(const p of picks){
        const query = (p.project_name && p.project_name.trim())
          ? `${p.project_name}, ${city}`
          : (p.area ? `${p.area} residential complex, ${city}` : city);
        try{
          const meta = await textSearchExact(query);
          const resolvedName = meta?.name || p.project_name || "";
          out.push({...p, project_name: resolvedName, g_rating: meta?.rating ?? null, lat: meta?.lat ?? null, lng: meta?.lng ?? null, vicinity: meta?.vicinity || p.area || ""});
        }catch{
          out.push(p);
        }
      }
      return out;
    }

    // --- Locality resolver (works globally)
    async function resolveLocalityPoint(city, locality){
      if(!locality || !window.google || !google.maps?.places) return null;
      const service = new google.maps.places.PlacesService(document.createElement('div'));
      return new Promise(resolve=>{
        service.textSearch({query:`${locality}, ${city}`}, (res, status)=>{
          if(status===google.maps.places.PlacesServiceStatus.OK && res && res.length){
            const r=res[0];
            resolve({
              lat: r.geometry?.location?.lat?.(),
              lng: r.geometry?.location?.lng?.()
            });
          } else resolve(null);
        });
      });
    }

    // --- Utility distance
    function distMeters(a,b){
      if(!a||!b||typeof a.lat!=='number'||typeof a.lng!=='number'||typeof b.lat!=='number'||typeof b.lng!=='number') return Infinity;
      const R=6371000, toRad=x=>x*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const la=toRad(a.lat), lb=toRad(b.lat);
      const h=Math.sin(dLat/2)**2 + Math.cos(la)*Math.cos(lb)*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.min(1,Math.sqrt(h)));
    }

    // --- Strict filter with parameters (DEFAULT RADIUS NOW 2000 m)
    function applyFinderFilters(payload, picks, localityPoint, opts={}){
      const price = v => (typeof v === 'number' && isFinite(v)) ? v : null;
      const BUDGET = Number(payload.budget || 0);
      const TYPE = (payload.type || '').trim();
      const PRICE_SLACK_PCT = opts.priceSlackPct ?? 15;   // ¬±15%
      const LOC_RADIUS_M     = opts.locRadiusM    ?? 2000; // ***** 2 km default *****
      const requireGeometry  = !!opts.requireGeometry;
      const hasLocality = !!localityPoint;

      const minPrice = BUDGET * (1 - PRICE_SLACK_PCT/100);
      const maxPrice = BUDGET * (1 + PRICE_SLACK_PCT/100);

      return (picks || []).filter(p=>{
        if (TYPE && p.apartment_type && p.apartment_type !== TYPE) return false;

        const pr = price(p.price);
        if (BUDGET > 0 && pr !== null){
          if (pr < minPrice || pr > maxPrice) return false;
        }

        if (hasLocality){
          if (typeof p.lat === 'number' && typeof p.lng === 'number'){
            const d = distMeters(localityPoint, {lat: p.lat, lng: p.lng});
            if (d > LOC_RADIUS_M) return false;
          } else if (requireGeometry) {
            return false;
          }
        }
        return true;
      });
    }

    // --- Relaxation ladder: keep radius locked at 2000 m; only relax price if needed
    async function relaxAndFilter(payload, picks, localityPoint){
      const TARGET = 10;
      const radiusSteps = localityPoint ? [2000] : [35000]; // ***** lock to 2 km when locality specified *****
      const priceSteps  = [15, 20, 25, 30, 35];

      for (const r of radiusSteps){
        for (const p of priceSteps){
          const out = applyFinderFilters(payload, picks, localityPoint, {locRadiusM:r, priceSlackPct:p, requireGeometry:true});
          if (out.length >= TARGET) return {out, r, p, strictGeo:true};
        }
      }
      for (const r of radiusSteps){
        for (const p of priceSteps){
          const out = applyFinderFilters(payload, picks, localityPoint, {locRadiusM:r, priceSlackPct:p, requireGeometry:false});
          if (out.length >= TARGET) return {out, r, p, strictGeo:false};
        }
      }
      const fallback = applyFinderFilters(payload, picks, localityPoint, {locRadiusM:radiusSteps.at(-1), priceSlackPct:priceSteps.at(-1), requireGeometry:false});
      return {out: fallback, r: radiusSteps.at(-1), p: priceSteps.at(-1), strictGeo:false};
    }

    // --- NEW: Harvest nearby residential projects within 5 km if not enough results
    async function harvestNearbyProjects({ localityPoint, city, currency, type, budget, needCount, priceSlackPct=25 }){
      if(!window.google || !google.maps?.places || !localityPoint || !needCount) return [];
      const service = new google.maps.places.PlacesService(document.createElement('div'));
      const center = new google.maps.LatLng(localityPoint.lat, localityPoint.lng);

      // Helper: Nearby Search with pagination
      function nearbyWithPagination(req, cap=60){
        return new Promise(resolve=>{
          let acc=[];
          const handle = (res, status, pag)=>{
            if(status===google.maps.places.PlacesServiceStatus.OK && res && res.length){
              acc = acc.concat(res);
              if(pag && pag.hasNextPage && acc.length<cap){
                // Places API requires a small delay before calling nextPage
                setTimeout(()=>pag.nextPage(), 1200);
              } else resolve(acc);
            } else {
              resolve(acc);
            }
          };
          service.nearbySearch(req, handle);
        });
      }

      // Helper: simple Text Searches around city keywords
      function textSearchMany(queries, cap=30){
        return Promise.all(queries.map(q => new Promise(resolve=>{
          service.textSearch({query:q}, (res, status)=>{
            if(status===google.maps.places.PlacesServiceStatus.OK && res && res.length) resolve(res.slice(0,cap));
            else resolve([]);
          });
        }))).then(arrs => arrs.flat());
      }

      // We‚Äôll try nearbySearch with keywords + a few textSearch queries
      const keywords = [
        "apartment",
        "residential complex",
        "housing society",
        "condominium",
        "residential tower"
      ];

      const nearbyPromises = keywords.map(kw => nearbyWithPagination({
        location: center,
        radius: 2000,
        keyword: kw
      }, 60));

      const textQueries = keywords.map(kw => `${kw} near ${city}`);
      const [nearbyResults, textResults] = await Promise.all([
        Promise.all(nearbyPromises).then(x=>x.flat()),
        textSearchMany(textQueries, 30)
      ]);

      const merge = [...nearbyResults, ...textResults];

      // Normalize, dedupe and keep within 5 km strictly
      const seen = new Set();
      const picked = [];
      for(const r of merge){
        const name = (r.name || "").trim();
        const loc = r.geometry && r.geometry.location;
        const lat = loc ? (typeof loc.lat==='function' ? loc.lat() : loc.lat) : null;
        const lng = loc ? (typeof loc.lng==='function' ? loc.lng() : loc.lng) : null;
        if(!name || typeof lat !== 'number' || typeof lng !== 'number') continue;
        const d = distMeters(localityPoint, {lat, lng});
        if(d > 2000) continue; // hard fence

        const key = name.toLowerCase();
        if(seen.has(key)) continue;
        seen.add(key);

        // Price heuristic: set near budget with band based on slack
        const slack = Math.max(15, Math.min(40, priceSlackPct));
        const low = Math.round(budget * (1 - slack/100));
        const high = Math.round(budget * (1 + slack/100));
        const approxPrice = Math.round((low + high)/2);

        picked.push({
          project_name: name,
          area: r.vicinity || r.formatted_address || city || "",
          apartment_type: type,
          size: "", // unknown from Places
          price: approxPrice,
          price_band: `${fmtMoney(low, currency)}‚Äì${fmtMoney(high, currency)}`,
          pros: ["Exact Maps match","Within 2 km of chosen locality"],
          cons: ["Verify age, amenities & maintenance"],
          notes: "",
          g_rating: (typeof r.rating==='number') ? r.rating : null,
          lat, lng
        });

        if(picked.length >= needCount) break;
      }

      return picked;
    }

    function renderFinder(summary, picks, currency){
      pfSummaryEl().textContent = summary || "(no summary)";
      pfCardsEl().innerHTML = (picks||[]).slice(0,12).map((p,i)=>{
        const price = fmtMoney(p.price, currency);
        const band = escapeHTML(p.price_band||"");
        const title = escapeHTML(p.project_name || `Project ${i+1}`);
        const area = escapeHTML(p.area||"-");
        const apt = escapeHTML(p.apartment_type||"-");
        const size = escapeHTML(p.size||"-");
        const pros = (p.pros||[]).map(x=>`<span class="pill">${escapeHTML(x)}</span>`).join(" ");
        const cons = (p.cons||[]).map(x=>`<span class="pill">${escapeHTML(x)}</span>`).join(" ");
        const notes = escapeHTML(p.notes||"");
        const gRating = (typeof p.g_rating==='number') ? `<span class="rating"><span class="star">‚òÖ</span>${p.g_rating.toFixed(1)}</span>` : '';
        return `
          <div class="prop-card">
            <div class="prop-title">${title}</div>
            <div class="text-muted small mb-1">${area} ‚Ä¢ ${apt} ‚Ä¢ ${size || '‚Äî'}</div>
            ${gRating ? `<div class="text-muted small mb-1">${gRating}</div>` : ''}
            <div class="mt-1"><span class="price">${price}</span> <span class="text-muted">(${band})</span></div>
            <div class="mt-2">
              <div class="text-muted small mb-1">Pros</div>
              <div class="d-flex flex-wrap gap-1">${pros || '<span class="pill">‚Äî</span>'}</div>
            </div>
            <div class="mt-2">
              <div class="text-muted small mb-1">Cons</div>
              <div class="d-flex flex-wrap gap-1">${cons || '<span class="pill">‚Äî</span>'}</div>
            </div>
            <div class="mt-2 small text-muted">${notes}</div>
          </div>`;
      }).join("");

      if(!picks.length){
        pfTableBody().innerHTML = `<tr><td colspan="8" class="text-muted">No results returned. Try adjusting inputs.</td></tr>`;
      } else {
        pfTableBody().innerHTML = picks.map((p,i)=>{
          const price = fmtMoney(p.price, currency);
          const band = escapeHTML(p.price_band||"");
          const title = escapeHTML(p.project_name || `Project ${i+1}`);
          const area = escapeHTML(p.area||"-");
          const apt = escapeHTML(p.apartment_type||"-");
          const size = escapeHTML(p.size||"-");
          const rating = (typeof p.g_rating==='number') ? p.g_rating.toFixed(1) : "";
          return `<tr>
            <td>${i+1}</td><td>${title}</td><td>${area}</td><td>${apt}</td><td>${size}</td>
            <td>${price}</td><td>${band}</td><td>${rating}</td>
          </tr>`;
        }).join("");
        pfBtnCSV().disabled=false; pfBtnXLSX().disabled=false; pfBtnCopyNames().disabled=false;
      }
    }

    async function runPropertyFinder(){
      const country = document.getElementById('pfCountry').value.trim();
      const city = (document.getElementById('pfCity').value || "").trim();
      const currency = document.getElementById('pfCurrency').value;
      const type = document.getElementById('pfType').value;
      const budget = Number(document.getElementById('pfBudget').value || 0);
      const locality = (document.getElementById('pfLocality').value || "").trim();

      const errBox = document.getElementById('pfError');
      errBox.classList.add('d-none');
      if(!city){ errBox.textContent="Please enter a city."; errBox.classList.remove('d-none'); return; }
      if(!(budget>0)){ errBox.textContent="Please enter a valid numeric budget."; errBox.classList.remove('d-none'); return; }

      const payload = { country, city, currency, type, budget, locality };
      const msgs = pfPrompt(payload);

      pfSummaryEl().textContent = "Working‚Ä¶ generating project suggestions‚Ä¶";
      pfCardsEl().innerHTML = "";
      pfTableBody().innerHTML = `<tr><td colspan="8" class="text-muted">Working...</td></tr>`;
      pfBtnCSV().disabled = true; pfBtnXLSX().disabled = true; pfBtnCopyNames().disabled = true;

      let parsed = null;
      try{
        if(!OPENAI_KEY) throw new Error("OpenAI key not configured");
        const controller = new AbortController();
        const t = setTimeout(()=>controller.abort(), 7000);
        const resp = await fetch('https://api.openai.com/v1/chat/completions', {
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${OPENAI_KEY}` },
          body: JSON.stringify({
            model: "gpt-4.1",
            temperature: 0.2,
            response_format: { type: "json_object" },
            messages: msgs
          }),
          signal: controller.signal
        });
        clearTimeout(t);
        if(!resp.ok){
          const tx = await resp.text();
          throw new Error(`OpenAI error ${resp.status}: ${tx.slice(0,120)}`);
        }
        const data = await resp.json();
        const jsonText = (data?.choices?.[0]?.message?.content || "{}");
        parsed = JSON.parse(jsonText);
      }catch(e){
        console.warn("OpenAI unavailable, using local heuristic. Reason:", e.message || e);
        parsed = localHeuristicFinder(payload);
      }

      // Resolve locality coordinate (global)
      let localityPoint = null;
      try { localityPoint = await resolveLocalityPoint(city, locality); } catch {}

      const picksRaw = Array.isArray(parsed.picks) ? parsed.picks : [];
      let picks = await enrichWithPlaceMeta(picksRaw, city); // add exact map name + lat/lng when possible

      // Relax and filter to get ~10 within 5 km of locality (if provided)
      const beforeCount = picks.length;
      const relaxed = await relaxAndFilter(payload, picks, localityPoint);
      picks = relaxed.out;

      // -------- NEW: Harvest within 5 km if locality is set and we still have < TARGET --------
      const TARGET = 10;
      let harvestedCount = 0;
      if (localityPoint && picks.length < TARGET) {
        try{
          const need = TARGET - picks.length;
          const harvested = await harvestNearbyProjects({
            localityPoint,
            city,
            currency,
            type,
            budget,
            needCount: need,
            priceSlackPct: Math.max(relaxed.p, 25) // use relaxed price or 25%, whichever higher
          });

          // Merge-dedupe by name (case-insensitive)
          const existingNames = new Set(picks.map(p=>(p.project_name||"").toLowerCase().trim()));
          for(const h of harvested){
            const key = (h.project_name||"").toLowerCase().trim();
            if(!existingNames.has(key)){
              picks.push(h);
              existingNames.add(key);
              harvestedCount++;
              if(picks.length >= TARGET) break;
            }
          }
        }catch(err){
          console.warn("Harvest failed:", err);
        }
      }

      // Hard limit to 12 for UI (cards/table show first 12)
      pfResults = picks.slice(0, 12);

      const localityTxt = localityPoint
        ? `Locality center @ (${localityPoint.lat?.toFixed(4)}, ${localityPoint.lng?.toFixed(4)})`
        : (locality ? `Locality "${locality}" not resolved` : `No locality filter`);

      const finalSummary =
        (parsed.summary ? parsed.summary + '\n' : '') +
        `‚Ä¢ Search completed for ${payload.type} properties in ${payload.city}\n` +
        `‚Ä¢ Found ${pfResults.length} matching projects within your budget and preferences`;

      renderFinder(finalSummary, pfResults, currency);
    }

    document.getElementById('btnFindProperties').addEventListener('click', runPropertyFinder);
    document.getElementById('btnClearPF').addEventListener('click', ()=>{
      document.getElementById('pfCity').value="";
      document.getElementById('pfBudget').value="";
      document.getElementById('pfLocality').value="";
      pfSummaryEl().textContent="‚Äî";
      pfCardsEl().innerHTML="";
      pfTableBody().innerHTML=`<tr><td colspan="8" class="text-muted">Run a search to populate results.</td></tr>`;
      document.getElementById('pfError').classList.add('d-none');
      pfResults = [];
      pfBtnCSV().disabled = true; pfBtnXLSX().disabled = true; pfBtnCopyNames().disabled = true;
    });

    // Copy names + exports
    document.getElementById('btnPFCopyNames').addEventListener('click', ()=>{
      if(!pfResults.length) return;
      const names = pfResults.map(p=>p.project_name || "").filter(Boolean).join("\n");
      navigator.clipboard.writeText(names).then(()=>{
        const btn = pfBtnCopyNames(); const old = btn.textContent;
        btn.textContent = "Copied!"; setTimeout(()=>btn.textContent=old, 1200);
      });
    });
    function csvCell(val){ const s = (val != null ? val : '').toString().replace(/"/g,'""'); return `"${s}"`; }
    function downloadBlob(filename, blob){
      const a = document.createElement('a'); const url = URL.createObjectURL(blob);
      a.href = url; a.download = filename; a.style.display = 'none'; document.body.appendChild(a);
      a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 100);
    }
    document.getElementById('btnPFExportCSV').addEventListener('click', ()=>{
      if(!pfResults.length) return;
      const header = ["Project (Exact Map Name)","Area","Type","Size","Price","Band","Rating"];
      const rows = pfResults.map(p=>[
        p.project_name||"", p.area||"", p.apartment_type||"", p.size||"",
        p.price||"", p.price_band||"", (typeof p.g_rating==='number')?p.g_rating:""
      ]);
      const csv = [header.join(",")].concat(rows.map(r=>r.map(csvCell).join(","))).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      downloadBlob(`project_finder_${Date.now()}.csv`, blob);
    });
    document.getElementById('btnPFExportXLSX').addEventListener('click', ()=>{
      if(!pfResults.length) return;
      const data = [["Project (Exact Map Name)","Area","Type","Size","Price","Band","Rating"]]
        .concat(pfResults.map(p=>[
          p.project_name||"", p.area||"", p.apartment_type||"", p.size||"",
          p.price||"", p.price_band||"", (typeof p.g_rating==='number')?p.g_rating:""
        ]));
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Projects");
      const ab = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([ab], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      downloadBlob(`project_finder_${Date.now()}.xlsx`, blob);
    });

    // ======================= MAPS: RETAIL =======================
    let map2=null, marker2=null, circle2=null;
    let placesService2=null;
    let autocomplete2=null;
    let lastRetailScan=null, lastRetailResults=null;

    const DEFAULT_POI_TYPES = [
      {type:'hospital',label:'Hospitals',weight:1.6,color:'#ef4444',emoji:'üè•'},
      {type:'pharmacy',label:'Pharmacies',weight:1.4,color:'#f59e0b',emoji:'üíä'},
      {type:'doctor',label:'Clinics',weight:1.3,color:'#10b981',emoji:'ü©∫'},
      {type:'police',label:'Police Stations',weight:1.5,color:'#1f2937',emoji:'ÔøΩ'},
      {type:'school',label:'Schools',weight:1.2,color:'#2563eb',emoji:'üè´'},
      {type:'bank',label:'Banks',weight:0.5,color:'#64748b',emoji:'ÔøΩ'},
      {type:'transit_station',label:'Transit',weight:1.1,color:'#f59e0b',emoji:'üöå'},
      {type:'subway_station',label:'Metro/Subway',weight:1.1,color:'#14b8a6',emoji:'üöá'},
      {type:'supermarket',label:'Supermarkets',weight:0.9,color:'#9333ea',emoji:'üõí'},
      {type:'store',label:'Stores',weight:0.4,color:'#475569',emoji:'üè™'},
      {type:'ambulance',label:'Ambulances',weight:1.7,color:'#dc2626',emoji:'ÔøΩ'},
      {type:'university',label:'Universities',weight:1.0,color:'#7c3aed',emoji:'ÔøΩ'},
      {type:'gym',label:'Gyms',weight:0.6,color:'#0ea5e9',emoji:'üèãÔ∏è'},
      {type:'restaurant',label:'Restaurants',weight:0.8,color:'#16a34a',emoji:'üçΩÔ∏è'},
      {type:'cafe',label:'Caf√©s',weight:0.7,color:'#dc2626',emoji:'‚òï'},
      {type:'shopping_mall',label:'Shopping Malls',weight:1.0,color:'#ea580c',emoji:'üõçÔ∏è'}
    ];

    function safeInitMaps(){ try{ initMap2(); }catch(e){ console.warn("Map2 init error", e); } }



    // Map 2 (Retail)
    const markersByType={};
    function initMap2(){
      if(!document.getElementById('map2')) return;
  map2=new google.maps.Map(document.getElementById('map2'),{center:{lat:22.5726,lng:88.3639},zoom:12,mapTypeControl:false,streetViewControl:false});
      placesService2=new google.maps.places.PlacesService(map2);
      const input=document.getElementById('searchBox2');
      autocomplete2=new google.maps.places.Autocomplete(input,{fields:["geometry","name"]});
      autocomplete2.addListener('place_changed',()=>{
        const p=autocomplete2.getPlace(); if(!p.geometry||!p.geometry.location) return;
        const latlng={lat:p.geometry.location.lat(),lng:p.geometry.location.lng()};
        map2.setCenter(latlng); map2.setZoom(15); setMarker2(latlng);
      });
      map2.addListener('click',e=>setMarker2({lat:e.latLng.lat(),lng:e.latLng.lng()}));
      document.getElementById('retailRadius').addEventListener('input',e=>{document.getElementById('retailRadiusLbl').textContent=e.target.value; if(marker2) drawCircle2();});
      document.getElementById('retailLimit').addEventListener('input',e=>document.getElementById('retailLimitLbl').textContent=e.target.value);
      buildPOIControls();
    }
    function setMarker2(latlng){
      if(marker2) marker2.setMap(null);
      marker2=new google.maps.Marker({position:latlng,map:map2});
      drawCircle2(); document.getElementById('retailLatLng').textContent=`${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
    }
    function drawCircle2(){
      const radius=parseInt(document.getElementById('retailRadius').value||'1000');
      const latlng=marker2.getPosition(); if(circle2) circle2.setMap(null);
      circle2=new google.maps.Circle({map:map2,center:latlng,radius:radius,fillOpacity:.05,strokeColor:'#2563eb'});
    }
    function clearMarkers(){ Object.values(markersByType).forEach(arr=>arr.forEach(m=>m.setMap(null))); Object.keys(markersByType).forEach(k=>markersByType[k]=[]); }
    function buildPOIControls(){
      const list=document.getElementById('poiList'); list.innerHTML='';
      const legend=document.getElementById('poiLegend'); legend.innerHTML='<span class="me-2">Legend:</span>';
      DEFAULT_POI_TYPES.forEach(t=>{
        const div=document.createElement('div'); div.className='col-12';
        div.innerHTML=`
          <div class="d-flex align-items-center gap-2">
            <span class="legend-dot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${t.color}"></span>
            <div class="form-check form-switch me-2">
              <input class="form-check-input" type="checkbox" id="poi_ck_${t.type}" checked>
              <label class="form-check-label" for="poi_ck_${t.type}">${t.emoji} ${t.label}</label>
            </div>
            <div class="input-group input-group-sm" style="width:150px">
              <span class="input-group-text">Weight</span>
              <input id="poi_wt_${t.type}" type="number" class="form-control" step="0.1" value="${t.weight}">
            </div>
          </div>`;
        list.appendChild(div);
        const lg=document.createElement('span'); lg.innerHTML=`<span class="legend-dot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${t.color}"></span>${t.emoji} ${t.label} `;
        legend.appendChild(lg);
      });
    }

    function makeEmojiMarkerOptions(t, position){
      return { position, map:map2,
        icon:{ path:google.maps.SymbolPath.CIRCLE, scale:7, fillColor:t.color, fillOpacity:1, strokeColor:'#333', strokeWeight:0.5 },
        label:{ text:t.emoji, fontSize:'12px' }, title:t.label };
    }
    async function nearbySearchAllTypes(center, radius, limit){
      const openNowSel=document.getElementById('openNow').value;
      const openNow=openNowSel==='yes'?true:undefined;
      const selected=DEFAULT_POI_TYPES.filter(t=>document.getElementById('poi_ck_'+t.type).checked);
      const resultsByType={}; clearMarkers();
      for(const t of selected){
        resultsByType[t.type]=await new Promise(resolve=>{
          let out=[]; const req={location:center, radius:radius, type:t.type, openNow};
          placesService2.nearbySearch(req,(res,status,pag)=>{
            if(status===google.maps.places.PlacesServiceStatus.OK && res){
              out=out.concat(res);
              if(pag && pag.hasNextPage && out.length<limit){ setTimeout(()=>pag.nextPage(),250); }
              else resolve(out.slice(0,limit));
            } else resolve(out);
          });
        });
        markersByType[t.type]=[];
        (resultsByType[t.type]||[]).forEach(p=>{
          if(!p.geometry||!p.geometry.location) return;
          const meta = DEFAULT_POI_TYPES.find(x=>x.type===t.type) || {color:'#2563eb',emoji:'‚Ä¢',label:t.label};
          const m=new google.maps.Marker(makeEmojiMarkerOptions(meta,p.geometry.location));
          markersByType[t.type].push(m);
        });
      }
      return resultsByType;
    }

    document.getElementById('btnScanPOI').addEventListener('click', async ()=>{
      if(!marker2){ alert('Pick a center on the map (or paste a project name).'); return; }
      const center=marker2.getPosition();
      const radius=parseInt(document.getElementById('retailRadius').value||'1000');
      const limit=parseInt(document.getElementById('retailLimit').value||'40');
      const minRating=parseFloat(document.getElementById('minRating').value||'0');
      const centerLatLng={lat:center.lat(), lng:center.lng()};
      const results=await nearbySearchAllTypes(centerLatLng, radius, limit);
      lastRetailResults = results;
      const filtered = {}; Object.keys(results).forEach(t=>{ filtered[t]=(results[t]||[]).filter(x=>(x.rating||0)>=minRating); });
      const counts={}, ratings={};
      Object.keys(filtered).forEach(t=>{
        const arr=filtered[t]||[]; counts[t]=arr.length;
        ratings[t]=arr.length ? (arr.reduce((s,x)=>s+(x.rating||0),0)/arr.length) : 0;
      });
      lastRetailScan={center:centerLatLng, radius, counts, ratings, minRating, openNow:document.getElementById('openNow').value};
      document.getElementById('retTypes').textContent=Object.keys(results).length.toString();
      document.getElementById('retRadius').textContent=radius.toString();
      document.getElementById('retMeta').textContent=`Rating>=${minRating||'any'}; Open:${lastRetailScan.openNow}`;
      document.getElementById('retailBreakdown').textContent=
        `Scanned ${Object.keys(results).length} types within ${radius}m.\nCounts: ${JSON.stringify(counts)}\nAvg ratings: ${JSON.stringify(ratings)}\nClick "Compute Score".`;
      document.getElementById('scoreErr').classList.add('d-none');
      document.getElementById('btnScoreRetail').disabled = false;
      const sel = document.getElementById('poiCategory');
      sel.innerHTML = `<option value="" selected disabled>‚Äî choose a category ‚Äî</option>`;
      Object.keys(lastRetailResults||{}).forEach(k=>{
        const meta = DEFAULT_POI_TYPES.find(z=>z.type===k);
        const lbl = meta ? `${meta.emoji} ${meta.label}` : k;
        sel.insertAdjacentHTML('beforeend', `<option value="${k}">${lbl} (${counts[k]||0})</option>`);
      });
      renderPOIFlatList();
    });

    document.getElementById('btnScoreRetail').addEventListener('click', async ()=>{
      try{
        if(!pyReady){ alert('Python engine is still loading. Please try again.'); return; }
        if(!lastRetailScan){ alert('Run "Scan Area" first.'); return; }
        const weights = {};
        DEFAULT_POI_TYPES.forEach(t => {
          const ckEl = document.getElementById('poi_ck_' + t.type);
          const wtEl = document.getElementById('poi_wt_' + t.type);
          weights[t.type] = (ckEl && ckEl.checked) ? (isFinite(parseFloat(wtEl.value)) ? parseFloat(wtEl.value) : 0) : 0;
        });
        const cts = {}, rts = {};
        Object.keys(weights).forEach(k=>{
          const c = parseFloat((lastRetailScan.counts && lastRetailScan.counts[k]) || 0);
          const r = parseFloat((lastRetailScan.ratings && lastRetailScan.ratings[k]) || 0);
          cts[k] = isFinite(c) ? c : 0;
          rts[k] = isFinite(r) ? r : 0;
        });
        const payload = { counts: cts, ratings: rts, weights, radius_m: Number(lastRetailScan.radius) || 1 };
        pyodide.globals.set('score_payload', JSON.stringify(payload));
        const result = await pyodide.runPythonAsync(`
import json, math
def score_retail(counts_by_type, avg_rating_by_type, weights, radius_m):
    keys=set(list((counts_by_type or {}).keys())+list((weights or {}).keys())+list((avg_rating_by_type or {}).keys()))
    score=0.0; detail={}
    for t in keys:
        c=float(counts_by_type.get(t,0) or 0); w=float(weights.get(t,0) or 0); r=float(avg_rating_by_type.get(t,0) or 0)
        rb=max(0.0,(r-3.0)*0.5); part=w*(c+rb); detail[t]={"count":c,"weight":w,"avg_rating":r,"component":part}; score+=part
    norm=score/max(1.0, math.log(max(10.0, float(radius_m or 1))))
    return {"raw_score":score,"normalized_score":norm,"detail":detail}

p = json.loads(score_payload)
result = score_retail(p["counts"], p["ratings"], p["weights"], p["radius_m"])
json.dumps(result)
        `);
        const obj = JSON.parse(result);
        document.getElementById('retRaw').textContent = (+obj.raw_score).toFixed(2);
        document.getElementById('retNorm').textContent = (+obj.normalized_score).toFixed(3);
        const tb = document.getElementById('retTableBody'); tb.innerHTML='';
        Object.entries(obj.detail).forEach(([t,d])=>{
          const meta = DEFAULT_POI_TYPES.find(x=>x.type===t);
          const lbl = meta ? `${meta.emoji} ${meta.label}` : t;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${lbl}</td><td>${(+d.count).toFixed(0)}</td><td>${(+d.avg_rating).toFixed(2)}</td><td>${(+d.weight).toFixed(2)}</td><td>${(+d.component).toFixed(2)}</td>`;
          tb.appendChild(tr);
        });
        const lines = [];
        lines.push(`Center: ${lastRetailScan.center.lat.toFixed(6)}, ${lastRetailScan.center.lng.toFixed(6)}`);
        lines.push(`Radius: ${lastRetailScan.radius} m`);
        lines.push(`Filters: rating>=${lastRetailScan.minRating||'any'}; open=${lastRetailScan.openNow}`);
        lines.push(`Raw Score: ${(+obj.raw_score).toFixed(2)} ‚Ä¢ Normalized: ${(+obj.normalized_score).toFixed(3)}`);
        document.getElementById('retailBreakdown').textContent = lines.join('\n');
        document.getElementById('scoreErr').classList.add('d-none');
      }catch(err){
        console.error('Compute Score error:', err);
        const box = document.getElementById('scoreErr');
        if(box){ box.textContent = (err && err.message) ? err.message : 'Scoring failed.'; box.classList.remove('d-none'); }
        else { alert('Scoring failed. See console for details.'); }
      }
    });

    // Tab 2 Reset Button
    document.getElementById('btnResetRetail').addEventListener('click', ()=>{
      // Clear map marker and POI markers
      if(marker2) { marker2.setMap(null); marker2 = null; }
      if(circle2) { circle2.setMap(null); circle2 = null; }
      clearMarkers(); // Clear all POI markers
      
      // Reset map to default center and zoom
      if(map2) {
        map2.setCenter({lat:22.5726,lng:88.3639});
        map2.setZoom(12);
      }
      
      // Clear search box
      const searchBox2 = document.getElementById('searchBox2');
      if(searchBox2) searchBox2.value = '';
      
      // Reset form controls to defaults
      document.getElementById('retailRadius').value = 1000;
      document.getElementById('retailRadiusLbl').textContent = '1000';
      document.getElementById('retailLimit').value = 50;
      document.getElementById('retailLimitLbl').textContent = '50';
      document.getElementById('minRating').value = 0;
      document.getElementById('openNow').value = 'any';
      
      // Reset POI category and filter
      document.getElementById('poiCategory').value = 'all';
      document.getElementById('poiFilterText').value = '';
      
      // Clear results
      ['retRaw', 'retNorm', 'retTypes', 'retRadius', 'retMeta'].forEach(id => 
        document.getElementById(id).textContent = '‚Äî'
      );
      
      // Clear breakdown table and text
      const tbody = document.getElementById('retTableBody');
      if(tbody) tbody.innerHTML = '';
      document.getElementById('retailBreakdown').textContent = '‚Äî';
      
      // Clear location display
      document.getElementById('retailLatLng').textContent = '‚Äî';
      
      // Disable compute score button
      document.getElementById('btnScoreRetail').disabled = true;
      
      // Clear stored scan data
      lastRetailScan = null;
      
      // Reset POI controls to defaults (rebuild them)
      buildPOIControls();
      
      // Clear flat POI list
      renderPOIFlatList();
    });

    const poiSel = document.getElementById('poiCategory');
    const poiFilter = document.getElementById('poiFilterText');
    ['change','input'].forEach(ev=>{
      document.getElementById('minRating').addEventListener(ev, renderPOIFlatList);
      document.getElementById('openNow').addEventListener(ev, renderPOIFlatList);
    });
    if(poiSel) poiSel.addEventListener('change', ()=> renderPOIFlatList());
    if(poiFilter) poiFilter.addEventListener('input', ()=> renderPOIFlatList());

    function normalizeResultItem(type, p, idx){
      let lat=null, lng=null;
      if (p && p.geometry && p.geometry.location) {
        const loc = p.geometry.location;
        lat = (typeof loc.lat === 'function') ? loc.lat() : loc.lat;
        lng = (typeof loc.lng === 'function') ? loc.lng() : loc.lng;
      }
      let queryLink = '';
      if (typeof lat === 'number' && typeof lng === 'number') {
        const latStr = lat.toFixed(7);
        const lngStr = lng.toFixed(7);
        queryLink = `https://www.google.com/maps/dir/?api=1&destination=${latStr},${lngStr}`;
      }
      return {
        idx: idx+1,
        name: p.name || '',
        address: p.vicinity || p.formatted_address || '',
        rating: typeof p.rating==='number' ? p.rating : '',
        ratingCount: p.user_ratings_total || '',
        isOpen: !!(p.opening_hours && p.opening_hours.open_now),
        type,
        link: queryLink
      };
    }
    function currentPOISelection(){
      if(!lastRetailResults) return [];
      const cat = poiSel.value;
      const arr = (cat && lastRetailResults[cat]) ? lastRetailResults[cat] : [];
      const minR = parseFloat(document.getElementById('minRating').value || '0');
      const openSel = document.getElementById('openNow').value;
      const ftxt = (poiFilter.value||'').toLowerCase();
      const rows = arr.map((p,i)=>normalizeResultItem(cat,p,i)).filter(r=>{
        const passRating = (r.rating === '' ? (minR <= 0) : Number(r.rating) >= minR);
        const passOpen = (openSel === 'any') ? true : r.isOpen === true;
        const hay = `${r.name} ${r.address}`.toLowerCase();
        const passQuick = ftxt ? hay.includes(ftxt) : true;
        return passRating && passOpen && passQuick;
      });
      return rows;
    }
    function renderPOIFlatList(){
      const body = document.getElementById('poiFlatBody');
      const rows = currentPOISelection();
      if(!rows.length){
        body.innerHTML = `<tr><td colspan="7" class="text-muted">No items ‚Äî select a category after scanning, or adjust your filters.</td></tr>`;
        return;
      }
      body.innerHTML = rows.map(r=>`<tr>
        <td>${r.idx}</td><td>${escapeHTML(r.name)}</td><td>${escapeHTML(r.address)}</td>
        <td>${r.rating!==''?Number(r.rating).toFixed(1):''}</td><td>${r.ratingCount}</td>
        <td>${r.type}</td>
        <td>${r.link ? `<a href="${r.link}" target="_blank" rel="noopener">Open</a>` : ''}</td>
      </tr>`).join('');
    }

    // Export functionality for Tab 2 POI data
    document.getElementById('btnExportCSV').addEventListener('click', ()=>{
      const rows = currentPOISelection();
      if(!rows.length) { alert('No POI data to export. Please scan an area and select a category first.'); return; }
      
      const header = ["#", "Name", "Address", "Rating", "Ratings Count", "Type", "Google Maps"];
      const csvRows = rows.map(r=>[
        r.idx, r.name, r.address, r.rating, r.ratingCount, r.type, r.link
      ]);
      const csv = [header.join(",")].concat(csvRows.map(r=>r.map(csvCell).join(","))).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      downloadBlob(`poi_analysis_${Date.now()}.csv`, blob);
    });
    
    document.getElementById('btnExportXLSX').addEventListener('click', ()=>{
      const rows = currentPOISelection();
      if(!rows.length) { alert('No POI data to export. Please scan an area and select a category first.'); return; }
      
      const data = [["#", "Name", "Address", "Rating", "Ratings Count", "Type", "Google Maps"]]
        .concat(rows.map(r=>[
          r.idx, r.name, r.address, r.rating, r.ratingCount, r.type, r.link
        ]));
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "POI Analysis");
      const ab = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([ab], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      downloadBlob(`poi_analysis_${Date.now()}.xlsx`, blob);
    });

    // Tab map reflow
    document.querySelectorAll('#mainTabs button[data-bs-toggle="tab"]').forEach(btn=>{
      btn.addEventListener('shown.bs.tab', e=>{
        if(window.google){
          if(e.target.id==='tab-retail' && map2){ const c=map2.getCenter(); google.maps.event.trigger(map2,'resize'); map2.setCenter(c); }
        }
      });
    });
  </script>
</body>
</html>
